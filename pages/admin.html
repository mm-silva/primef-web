<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRUD de Usuários</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11.0.19/dist/sweetalert2.min.css" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
</head>
<body class="bg-dark text-light">
    <div class="container mt-5">
        <h1 class="text-center mb-4">CRUD de Usuários</h1>
        <div id="permissionError" class="alert alert-danger d-none" role="alert">
            Você não tem permissão para acessar esta página.
        </div>
        <div id="content" class="d-none">
            <div class="row mb-3">
                <div class="col">
                    <button id="addUserBtn" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#userModal">Adicionar Usuário</button>
                </div>
            </div>
            <div class="table-responsive">
                <table class="table table-dark table-striped">
                    <thead>
                        <tr>
                            <th>Nome de Usuário</th>
                            <th>Email</th>
                            <th>Telefone</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody id="userTableBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Modal -->
    <div class="modal fade" id="userModal" tabindex="-1" aria-labelledby="userModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content bg-dark text-light">
                <div class="modal-header">
                    <h5 class="modal-title" id="userModalLabel">Adicionar/Editar Usuário</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="userForm">
                        <input type="hidden" id="userId">
                        <div class="mb-3">
                            <input type="text" class="form-control bg-secondary text-light" id="username" placeholder="Nome de usuário" required>
                        </div>
                        <div class="mb-3">
                            <input type="email" class="form-control bg-secondary text-light" id="email" placeholder="Email" required>
                        </div>
                        <div class="mb-3">
                            <input type="tel" class="form-control bg-secondary text-light" id="phone" placeholder="Telefone" required>
                        </div>
                        <div class="mb-3">
                            <input type="password" class="form-control bg-secondary text-light" id="password" placeholder="Senha" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                    <button type="button" class="btn btn-primary" id="saveUserBtn">Salvar Usuário</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.0.19/dist/sweetalert2.all.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
    const userForm = document.getElementById('userForm');
    const userTableBody = document.getElementById('userTableBody');
    const contentDiv = document.getElementById('content');
    const permissionErrorDiv = document.getElementById('permissionError');
    const addUserBtn = document.getElementById('addUserBtn');
    const saveUserBtn = document.getElementById('saveUserBtn');
    const userModal = new bootstrap.Modal(document.getElementById('userModal'));

    // Verificar permissão
    const permission = localStorage.getItem('permission');
    if (permission !== '1') {
        permissionErrorDiv.classList.remove('d-none');
        return;
    }

    contentDiv.classList.remove('d-none');

    // Carregar usuários ao iniciar a página
    loadUsers();

    // Adicionar evento de clique ao botão de salvar usuário
    saveUserBtn.addEventListener('click', saveUser);

    // Adicionar evento de clique ao botão de adicionar usuário
    addUserBtn.addEventListener('click', () => {
        clearForm();
        document.getElementById('userModalLabel').textContent = 'Adicionar Usuário';
    });

    // Função para obter o token de autenticação
    function getAuthToken() {
        return localStorage.getItem('token');
    }

    // Função para fazer requisições autenticadas
    async function authenticatedFetch(url, options = {}) {
        const token = getAuthToken();
        if (!token) {
            throw new Error('Token de autenticação não encontrado');
        }

        const headers = {
            ...options.headers,
            'Authorization': `Bearer ${token}`
        };

        return fetch(url, { ...options, headers });
    }

    // Função para carregar todos os usuários
    async function loadUsers() {
        try {
            const response = await authenticatedFetch('http://localhost:5000/api/user/');
            if (!response.ok) {
                throw new Error('Não foi possível carregar os usuários');
            }
            const users = await response.json();
            displayUsers(users);
        } catch (error) {
            console.error('Erro ao carregar usuários:', error);
            showAlert('error', 'Erro ao carregar usuários', error.message);
        }
    }

    // Função para exibir usuários na tabela
    function displayUsers(users) {
        userTableBody.innerHTML = '';
        users.forEach(user => {
            const row = userTableBody.insertRow();
            row.innerHTML = `
                <td>${user.username}</td>
                <td>${user.email}</td>
                <td>${user.phone}</td>
                <td>
                    <button class="btn btn-sm btn-info me-1" onclick="viewUser('${user._id}')">Ver</button>
                    <button class="btn btn-sm btn-danger" onclick="deleteUser('${user._id}')">Excluir</button>
                </td>
            `;
        });
    }

    // Função para visualizar detalhes do usuário
    window.viewUser = async function(userId) {
        try {
            const response = await authenticatedFetch(`http://localhost:5000/api/user/info?userId=${userId}`);
            if (!response.ok) {
                throw new Error('Não foi possível obter as informações do usuário');
            }
            const user = await response.json();
            document.getElementById('userId').value = userId;
            document.getElementById('username').value = user.name;
            document.getElementById('email').value = user.email;
            document.getElementById('phone').value = user.phone;
            document.getElementById('password').value = ''; // Limpar o campo de senha por segurança
            document.getElementById('userModalLabel').textContent = 'Editar Usuário';
            userModal.show();
        } catch (error) {
            console.error('Erro ao visualizar usuário:', error);
            showAlert('error', 'Erro ao visualizar usuário', error.message);
        }
    }

    // Função para salvar (criar ou atualizar) usuário
    async function saveUser() {
        const userId = document.getElementById('userId').value;
        const username = document.getElementById('username').value;
        const email = document.getElementById('email').value;
        const phone = document.getElementById('phone').value;
        const password = document.getElementById('password').value;

        const userData = {
            username: username,
            email: email,
            phone: phone,
            password: password
        };

        try {
            let response;
            if (userId) {
                // Atualizar usuário existente
                response = await authenticatedFetch(`http://localhost:5000/api/user/${userId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(userData),
                });
            } else {
                // Criar novo usuário
                response = await authenticatedFetch('http://localhost:5000/api/auth/register', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(userData),
                });
            }

            if (!response.ok) {
                throw new Error('Erro ao salvar usuário');
            }

            userModal.hide();
            clearForm();
            loadUsers();
            showAlert('success', 'Sucesso', 'Usuário salvo com sucesso!');
        } catch (error) {
            console.error('Erro ao salvar usuário:', error);
            showAlert('error', 'Erro ao salvar usuário', error.message);
        }
    }

    // Função para excluir usuário
    window.deleteUser = async function(userId) {
        const result = await Swal.fire({
            title: 'Tem certeza?',
            text: "Você não poderá reverter esta ação!",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: 'Sim, excluir!',
            cancelButtonText: 'Cancelar'
        });

        if (result.isConfirmed) {
            try {
                const response = await authenticatedFetch(`http://localhost:5000/api/user/${userId}`, {
                    method: 'DELETE',
                });

                if (!response.ok) {
                    throw new Error('Erro ao excluir usuário');
                }

                loadUsers();
                showAlert('success', 'Sucesso', 'Usuário excluído com sucesso!');
            } catch (error) {
                console.error('Erro ao excluir usuário:', error);
                showAlert('error', 'Erro ao excluir usuário', error.message);
            }
        }
    }

    // Função para limpar o formulário
    function clearForm() {
        document.getElementById('userId').value = '';
        document.getElementById('username').value = '';
        document.getElementById('email').value = '';
        document.getElementById('phone').value = '';
        document.getElementById('password').value = '';
    }

    // Função para exibir alertas usando SweetAlert2
    function showAlert(icon, title, text) {
        Swal.fire({
            icon: icon,
            title: title,
            text: text,
            customClass: {
                container: 'swal-dark'
            }
        });
    }
});


    </script>
</body>
</html>

